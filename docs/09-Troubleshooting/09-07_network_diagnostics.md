# bSolid ネットワーク問題診断・解決ガイド

**ファイル名**: `09-07_network_diagnostics.md`  
**カテゴリ**: ネットワーク・通信トラブルシューティング  
**対象**: システム管理者・技術者・オペレーター

---

## 📖 **概要**

bSolidシステムにおけるネットワーク関連の問題診断と解決方法を包括的に解説します。CAD/CAMシステムは機械制御、データ共有、ライセンス認証など、多様なネットワーク機能に依存しており、効率的なネットワークトラブルシューティングは生産性維持の鍵となります。

### **対象ネットワーク問題**
- **機械通信エラー**: CNC機械との接続・制御問題
- **ファイル共有問題**: ネットワークドライブ・共有フォルダアクセス
- **ライセンス認証問題**: フローティングライセンス・認証サーバー
- **データベース接続問題**: 中央データベース・同期エラー
- **リモートアクセス問題**: VPN・リモートデスクトップ接続
- **パフォーマンス問題**: 遅延・帯域幅・スループット

---

## 🔍 **ネットワーク診断の基本アプローチ**

### **レイヤー別診断手順**

#### **Layer 1: 物理層**
```
1. ケーブル接続確認
   - LANケーブル接続状態
   - ケーブル損傷・断線チェック
   - コネクタ接触不良確認

2. ネットワーク機器確認
   - スイッチ・ルーター動作状態
   - LED インジケーター確認
   - 電源・冷却状態チェック
```

#### **Layer 2: データリンク層**
```
1. MACアドレス解決
   - ARP テーブル確認
   - スイッチ MAC テーブル
   - VLAN 設定確認

2. リンク状態確認
   - ポート速度・Duplex設定
   - フレームエラー統計
   - collision/CRC エラー
```

#### **Layer 3: ネットワーク層**
```
1. IP設定確認
   - IPアドレス・サブネットマスク
   - デフォルトゲートウェイ
   - ルーティングテーブル

2. 接続性テスト
   - ping テスト（応答性）
   - traceroute（経路確認）
   - パケットロス測定
```

#### **Layer 4-7: 上位層**
```
1. アプリケーション接続
   - ポート開放状況
   - ファイアウォール設定
   - プロキシ・NAT設定

2. サービス稼働状況
   - DNS解決確認
   - アプリケーションサービス
   - 認証・セキュリティ
```

---

## 🔧 **機械通信問題の診断・解決**

### **CNC機械通信トラブル**

#### **症状: 機械と接続できない**

**原因分析**
```
□ ネットワーク設定
  - IPアドレス競合
  - サブネット設定ミス
  - ファイアウォールブロック

□ 機械側設定
  - ネットワークアダプタ無効
  - プロトコル設定エラー
  - 通信ポート設定ミス

□ 物理的問題
  - ケーブル断線・劣化
  - スイッチポート故障
  - ネットワークカード故障
```

**診断手順**
```powershell
# 1. 基本接続確認
ping [機械IPアドレス]
telnet [機械IPアドレス] [ポート番号]

# 2. ネットワーク設定確認
ipconfig /all
route print
netstat -an | findstr [ポート番号]

# 3. DNS・名前解決確認
nslookup [機械ホスト名]
ping [機械ホスト名]
```

**解決策**
```
1. IP設定の修正
   - 静的IP設定の見直し
   - DHCP予約設定
   - サブネット設定調整

2. ファイアウォール設定
   - 必要ポートの開放
   - アプリケーション例外追加
   - Windows Defender設定

3. 機械側設定確認
   - ネットワーク設定再設定
   - 通信プロトコル確認
   - ファームウェア更新
```

#### **症状: 通信が不安定・断続的**

**原因分析**
```
□ ネットワーク品質
  - パケットロス発生
  - 遅延・ジッター増大
  - 帯域幅不足

□ 設備問題
  - ノイズ・電磁干渉
  - ケーブル劣化
  - スイッチ過負荷

□ 設定問題
  - タイムアウト設定
  - バッファサイズ設定
  - プロトコル設定
```

**診断ツール活用**
```powershell
# パケットロス・遅延測定
ping -t -l 1472 [機械IPアドレス]
pathping [機械IPアドレス]

# 帯域幅測定
iperf3 -c [機械IPアドレス] -t 60

# ネットワーク統計
netstat -e
perfmon /s [ファイル名.msc]
```

**最適化対策**
```
1. QoS設定
   - 優先制御設定
   - 帯域幅保証
   - トラフィック分類

2. ネットワーク設計見直し
   - 専用VLAN構築
   - 冗長化構成
   - 負荷分散設定

3. 機器更新・強化
   - スイッチ能力向上
   - ケーブル・CAT6A化
   - ノイズ対策
```

---

## 📁 **ファイル共有問題の診断・解決**

### **ネットワークドライブアクセス問題**

#### **症状: 共有フォルダにアクセスできない**

**原因分析**
```
□ 認証・権限問題
  - ユーザー認証失敗
  - フォルダアクセス権限
  - Active Directory同期

□ ネットワーク設定
  - SMB プロトコル設定
  - ファイアウォール設定
  - NetBIOS名前解決

□ サーバー問題
  - ファイルサーバー停止
  - 共有設定エラー
  - ディスク容量不足
```

**診断コマンド**
```cmd
# 共有リスト確認
net view \\[サーバー名]
net use

# SMB接続テスト
telnet [サーバーIP] 445
ping [サーバー名]

# 権限確認
icacls [フォルダパス]
whoami /groups
```

**解決手順**
```
1. 認証情報リセット
   net use \\[サーバー名] /delete
   net use \\[サーバー名] /user:[ユーザー名]

2. SMB設定確認
   - SMBバージョン確認・設定
   - NTLMv2認証設定
   - セキュリティポリシー確認

3. ネットワーク設定修正
   - hosts ファイル設定
   - DNS設定確認
   - WINS設定確認
```

#### **症状: ファイル共有が遅い**

**パフォーマンス分析**
```powershell
# ネットワーク使用量監視
Get-Counter "\Network Interface(*)\Bytes Total/sec"
Get-Counter "\SMB Server Shares(*)\Data Bytes/sec"

# ディスクI/O監視
Get-Counter "\PhysicalDisk(*)\Disk Bytes/sec"
Get-Counter "\PhysicalDisk(*)\Avg. Disk Queue Length"
```

**最適化対策**
```
1. SMB設定最適化
   - SMB Direct有効化
   - 大きなMTU設定
   - SMB Multichannel有効化

2. キャッシュ設定
   - クライアント側キャッシュ
   - サーバー側キャッシュ
   - オフラインファイル設定

3. ハードウェア強化
   - NIC速度向上（1Gbps→10Gbps）
   - SSD使用によるディスクI/O向上
   - メモリ増設
```

---

## 🔐 **ライセンス認証問題の診断・解決**

### **フローティングライセンス問題**

#### **症状: ライセンスサーバーに接続できない**

**診断項目**
```
□ サーバー稼働確認
  - ライセンスサービス動作状態
  - サーバー応答性（ping）
  - ポート開放状況

□ クライアント設定
  - ライセンスサーバー設定
  - 環境変数設定
  - クライアントバージョン

□ ネットワーク経路
  - ルーティング設定
  - ファイアウォール設定
  - プロキシ設定
```

**診断手順**
```cmd
# ライセンスサーバー接続テスト
telnet [ライセンスサーバーIP] 27000
ping [ライセンスサーバーIP]

# ライセンス状況確認
lmutil lmstat -a
lmutil lmdiag

# 環境変数確認
echo %LM_LICENSE_FILE%
echo %VENDOR_LICENSE_FILE%
```

**解決方法**
```
1. サーバー側対応
   - ライセンスサービス再起動
   - ライセンスファイル再読み込み
   - ポート開放確認

2. クライアント側対応
   - ライセンスサーバー設定修正
   - 環境変数設定
   - キャッシュクリア

3. ネットワーク設定
   - ファイアウォール例外追加
   - ルーティング設定確認
   - VPN設定確認
```

---

## 📊 **ネットワークパフォーマンス診断**

### **遅延・スループット問題**

#### **パフォーマンス測定**

**基本測定ツール**
```powershell
# 応答時間・パケットロス
ping -t [対象IP]
ping -l 1472 [対象IP]  # MTU サイズテスト

# 経路・ホップ別遅延
tracert [対象IP]
pathping [対象IP]

# 帯域幅測定
iperf3 -c [サーバーIP] -t 60 -P 4
```

**高度な分析ツール**
```
1. Wireshark
   - パケットキャプチャ・解析
   - プロトコル詳細分析
   - 問題箇所の特定

2. PerfMon
   - システムリソース監視
   - ネットワーク統計
   - 長期トレンド分析

3. iperf3
   - TCP/UDP スループット測定
   - マルチストリーム測定
   - 双方向測定
```

#### **ボトルネック特定**

**チェックポイント**
```
□ クライアント側
  - CPU・メモリ使用率
  - ネットワークアダプタ使用率
  - アプリケーション処理能力

□ ネットワーク機器
  - スイッチ・ルーター負荷
  - ポート使用率
  - バッファ・キュー状況

□ サーバー側
  - CPU・メモリ・ディスクI/O
  - ネットワーク処理負荷
  - 同時接続数
```

**最適化対策**
```
1. クライアント最適化
   - ネットワークアダプタ設定調整
   - TCP ウィンドウサイズ最適化
   - 割り込み処理最適化

2. ネットワーク最適化
   - QoS設定による優先制御
   - VLAN分離による負荷分散
   - 冗長化・負荷分散構成

3. サーバー最適化
   - ハードウェア能力向上
   - ネットワークスタック調整
   - 負荷分散・クラスタ構成
```

---

## 🛠 **ネットワーク診断ツール活用**

### **Windows標準ツール**

#### **基本コマンド**
```cmd
# 基本接続確認
ping [IPアドレス/ホスト名]
ping -t [IPアドレス]           # 連続ping
ping -l [サイズ] [IPアドレス]  # パケットサイズ指定

# 経路確認
tracert [IPアドレス]
pathping [IPアドレス]

# 設定確認
ipconfig /all                  # IP設定表示
ipconfig /release              # IP解放
ipconfig /renew                # IP更新
ipconfig /flushdns             # DNSキャッシュクリア

# 接続状況確認
netstat -an                    # すべての接続表示
netstat -r                     # ルーティングテーブル
netstat -e                     # インタフェース統計

# 名前解決確認
nslookup [ホスト名]
nslookup [IPアドレス]          # 逆引き
```

#### **高度なコマンド**
```powershell
# PowerShell ネットワークコマンド
Test-NetConnection [ホスト名] -Port [ポート番号]
Get-NetAdapter                 # アダプタ情報
Get-NetIPConfiguration         # IP設定詳細
Get-NetRoute                   # ルーティング情報

# パフォーマンスカウンター
Get-Counter "\Network Interface(*)\Bytes Total/sec"
Get-Counter "\Network Interface(*)\Packets/sec"
```

### **専用ツール**

#### **iperf3（帯域幅測定）**
```bash
# サーバー側
iperf3 -s

# クライアント側
iperf3 -c [サーバーIP]                    # 基本測定
iperf3 -c [サーバーIP] -t 60              # 60秒測定
iperf3 -c [サーバーIP] -P 4               # 4並列測定
iperf3 -c [サーバーIP] -u -b 100M         # UDP、100Mbps制限
```

#### **Wireshark（パケット解析）**
```
1. 基本キャプチャ
   - インタフェース選択
   - フィルタ設定
   - キャプチャ開始

2. 分析機能
   - プロトコル階層統計
   - 会話（Conversations）分析
   - 入出力グラフ

3. フィルタ例
   ip.addr == 192.168.1.10     # 特定IPアドレス
   tcp.port == 80              # 特定ポート
   http                        # HTTPトラフィック
```

#### **TCPView（接続監視）**
```
機能:
- リアルタイム接続表示
- プロセス別接続監視
- 接続履歴追跡
- DNS逆引き表示
```

---

## 🔄 **継続的ネットワーク監視**

### **監視項目・閾値設定**

#### **基本指標**
```
□ 応答時間（ping）
  - 正常: <10ms
  - 注意: 10-50ms
  - 警告: 50-100ms
  - 異常: >100ms

□ パケットロス
  - 正常: 0%
  - 注意: 0.1-0.5%
  - 警告: 0.5-1%
  - 異常: >1%

□ 帯域幅使用率
  - 正常: <70%
  - 注意: 70-85%
  - 警告: 85-95%
  - 異常: >95%
```

#### **詳細指標**
```
□ インタフェース統計
  - エラーパケット率: <0.01%
  - 廃棄パケット率: <0.1%
  - コリジョン率: <0.1%

□ TCP統計
  - 再送率: <1%
  - 接続失敗率: <0.1%
  - タイムアウト率: <0.1%

□ アプリケーション応答
  - HTTP応答時間: <2秒
  - ファイル転送速度: >10MB/s
  - データベース応答: <1秒
```

### **自動監視・アラート**

#### **PowerShell監視スクリプト**
```powershell
# ネットワーク監視スクリプト例
function Test-NetworkHealth {
    param($targets)
    
    foreach ($target in $targets) {
        $ping = Test-NetConnection $target.IP -WarningAction SilentlyContinue
        if (-not $ping.PingSucceeded) {
            Send-MailMessage -To "admin@company.com" `
                           -Subject "Network Alert: $($target.Name) Down" `
                           -Body "Target $($target.IP) is not responding"
        }
    }
}

# 監視対象リスト
$networkTargets = @(
    @{Name="CNC Machine 1"; IP="192.168.1.10"},
    @{Name="File Server"; IP="192.168.1.20"},
    @{Name="License Server"; IP="192.168.1.30"}
)

# 定期実行（タスクスケジューラーと連携）
Test-NetworkHealth $networkTargets
```

#### **SNMP監視設定**
```
1. SNMP有効化
   - Windows機能有効化
   - コミュニティ名設定
   - セキュリティ設定

2. MIB情報収集
   - インタフェース統計
   - システム情報
   - パフォーマンス指標

3. 監視ツール連携
   - PRTG Network Monitor
   - Zabbix
   - Nagios
```

---

## 🚨 **緊急時対応プロトコル**

### **ネットワーク障害レベル**

#### **レベル1: 全体ネットワーク停止**
```
症状: インターネット・社内ネットワーク全体停止
対応: 
1. 即座に ISP・ネットワーク機器確認
2. 緊急連絡網による関係者通知
3. 代替手段（モバイル回線等）準備
4. 復旧見込み時間の連絡
```

#### **レベル2: 基幹システム通信停止**
```
症状: ファイルサーバー・ライセンスサーバー接続不可
対応:
1. サーバー・ネットワーク機器再起動
2. 代替サーバーへの切り替え検討
3. ローカル作業への移行
4. データ整合性確保措置
```

#### **レベル3: 機械通信問題**
```
症状: CNC機械との通信不良・不安定
対応:
1. 機械安全停止・現在作業保存
2. ネットワーク経路・設定確認
3. 有線接続・代替経路確認
4. 手動操作への移行検討
```

#### **レベル4: 部分的性能劣化**
```
症状: 特定サービス・機能の性能低下
対応:
1. 使用状況・負荷分散調整
2. 不要サービス・プロセス停止
3. 代替手段・回避策実施
4. 業務時間外での詳細調査
```

### **エスカレーション体制**

```
現場オペレーター（5分）
    ↓
現場リーダー（15分）
    ↓
IT担当者（30分）
    ↓
システム管理者（1時間）
    ↓
外部サポート（2時間）
```

---

## 📋 **予防保全・ベストプラクティス**

### **定期保全項目**

#### **日次チェック**
```
□ 基本接続確認
  - 主要サーバー・機械への ping
  - アプリケーション動作確認
  - エラーログ確認

□ パフォーマンス確認
  - ネットワーク使用率
  - 応答時間測定
  - 接続数・セッション数
```

#### **週次チェック**
```
□ 詳細統計確認
  - エラー・廃棄パケット統計
  - 帯域幅使用傾向
  - セキュリティログ確認

□ 設定・バックアップ確認
  - ネットワーク機器設定バックアップ
  - 証明書・ライセンス期限確認
  - セキュリティ更新確認
```

#### **月次チェック**
```
□ 包括的分析
  - 月間統計・トレンド分析
  - 容量計画・拡張検討
  - 脆弱性・セキュリティ評価

□ 設備・更新計画
  - ハードウェア寿命・更新計画
  - ソフトウェア・ファームウェア更新
  - 災害復旧計画確認
```

### **構成管理・文書化**

#### **ネットワーク図・文書**
```
1. 物理構成図
   - 機器配置・接続関係
   - ケーブル配線図
   - ラック・パネル構成

2. 論理構成図
   - VLAN設計・IP割り当て
   - ルーティング・スイッチング
   - セキュリティゾーン

3. 設定情報
   - 機器設定ファイル
   - IP・DNS・DHCP設定
   - ファイアウォール・ACL設定
```

#### **手順書・マニュアル**
```
1. 運用手順書
   - 監視・保全手順
   - 障害対応手順
   - 変更管理手順

2. 構築・設定手順
   - 機器導入・設定手順
   - アプリケーション設定
   - セキュリティ設定

3. 緊急時対応手順
   - 障害レベル別対応
   - エスカレーション手順
   - 復旧・ロールバック手順
```

---

## 📞 **サポート・問い合わせ**

### **社内サポート体制**
- **Level 1**: 現場オペレーター（基本確認・再起動）
- **Level 2**: IT担当者（設定確認・調整）
- **Level 3**: システム管理者（詳細分析・設計変更）
- **Level 4**: 外部専門業者（機器交換・大規模変更）

### **外部サポート**
- **ISP技術サポート**: インターネット接続・回線問題
- **機器ベンダーサポート**: ネットワーク機器・ファームウェア
- **ソフトウェアサポート**: bSolid・ライセンス関連
- **システムインテグレーター**: 設計・構築・運用支援

### **エスカレーション時の準備情報**
```
□ 基本情報
  - ネットワーク構成図
  - 機器型番・ファームウェアバージョン
  - IP設定・VLAN情報
  - 問題発生時刻・頻度

□ 診断結果
  - ping・traceroute結果
  - エラーログ・統計情報
  - パケットキャプチャ（可能な場合）
  - 設定変更履歴

□ 影響・緊急度
  - 業務・生産への影響範囲
  - 回避策の実施状況
  - 復旧要求時間
  - 代替手段の可用性
```

---

## 📚 **関連リソース**

### **技術参考資料**
- **[RFC文書](https://tools.ietf.org/rfc/)** - ネットワークプロトコル仕様
- **[Microsoft Docs](https://docs.microsoft.com/network/)** - Windows ネットワーク機能
- **[Wireshark User Guide](https://www.wireshark.org/docs/)** - パケット解析リファレンス
- **[iperf3 Documentation](https://iperf.fr/iperf-doc.php)** - 帯域幅測定ツール

### **トレーニング・認定**
- **[CompTIA Network+](https://www.comptia.org/certifications/network)** - ネットワーク基礎認定
- **[Cisco CCNA](https://www.cisco.com/c/en/us/training-events/training-certifications/certifications/associate/ccna.html)** - ネットワーク技術認定
- **[Microsoft Certified: Azure Network Engineer](https://docs.microsoft.com/learn/certifications/azure-network-engineer-associate/)** - クラウドネットワーク認定

### **監視・管理ツール**
- **[PRTG Network Monitor](https://www.paessler.com/prtg)** - 統合ネットワーク監視
- **[SolarWinds NPM](https://www.solarwinds.com/network-performance-monitor)** - ネットワークパフォーマンス監視
- **[Zabbix](https://www.zabbix.com/)** - オープンソース監視プラットフォーム

---

## 🎯 **まとめ**

効果的なネットワーク診断・トラブルシューティングは、bSolidシステムの安定稼働と生産性維持の基盤となります。体系的なアプローチ、適切な診断ツールの活用、そして予防保全により、ネットワーク関連問題を迅速に解決し、将来の問題を予防することが可能です。

### **成功の鍵**
1. **体系的診断**: レイヤー別・段階的アプローチ
2. **適切なツール**: 症状に応じた診断ツール選択
3. **継続的監視**: プロアクティブな問題発見
4. **迅速な対応**: 明確なエスカレーション体制
5. **知識の蓄積**: 問題・解決法のデータベース化

定期的な訓練・教育により、チーム全体のネットワークトラブルシューティング能力を向上させ、強固で信頼性の高いネットワーク環境を構築・維持してください。

---

**ファイル情報**  
- **作成日**: 2025-01-30  
- **バージョン**: 1.0  
- **対象システム**: bSolid CAD/CAM  
- **言語**: 日本語

[bSolid マニュアル目次へ戻る](../README.md) 